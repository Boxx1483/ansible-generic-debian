*filter

# default policies
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT DROP [0:0]

# allow all on loopback
-A INPUT -i lo -j ACCEPT
-A OUTPUT -o lo -j ACCEPT

# chain: LOG_AND_DROP
:LOG_AND_DROP - [0:0]
-A LOG_AND_DROP -m limit --limit 60/min -j LOG --log-prefix "IPTables Packet Dropped: " --log-level 7
-A LOG_AND_DROP -j DROP

# chain: LOG_AND_ACCEPT
:LOG_AND_ACCEPT - [0:0]
-A LOG_AND_ACCEPT -m limit --limit 60/min -j LOG --log-prefix "IPTables Packet accept: " --log-level 7
-A LOG_AND_ACCEPT -j ACCEPT

# allow established connections
-A INPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A OUTPUT -m conntrack --ctstate ESTABLISHED -j ACCEPT

# disallow invalid states
-A INPUT  -m conntrack --ctstate INVALID -j LOG_AND_DROP
-A OUTPUT -m conntrack --ctstate INVALID -j LOG_AND_DROP

# incoming: ssh
-A INPUT  -p tcp --dport 22 -m state --state NEW,ESTABLISHED -m limit --limit 12/min -j LOG_AND_ACCEPT
-A OUTPUT -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
# TODO: limit to MGNT LAN

# incoming: ping host
-A INPUT -p icmp --icmp-type echo-request -m limit --limit 60/min -j ACCEPT
# return packages accepted due to "RELATED"

# outgoing: DNS
-A OUTPUT -p udp --dport 53 -j ACCEPT
# return packages accepted due to "RELATED"
# TODO: limit to SRV LAN

# outgoing: SMTP
-A OUTPUT  -p tcp --dport 25 -m state --state NEW,ESTABLISHED -j LOG_AND_ACCEPT
# return packages accepted due to "RELATED"
# TODO: limit to SRV LAN

# outgoing: HTTP
-A OUTPUT -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j LOG_AND_ACCEPT
# return packages accepted due to "RELATED"
# needed due to updates
# TODO: limit to SRV LAN

# everything else is logged
-A OUTPUT -j LOG_AND_DROP
-A INPUT -j LOG_AND_DROP

COMMIT
